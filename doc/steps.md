## Steps definition

This document describes the steps that can be used in our pipelines. A step is
the unit of transformation generated by a user interaction with the visual query
builder.

### `aggregate` step

Perform aggregations on one or several columns.

An aggreation step has the following strucure:

```javascript
{
   name: 'aggregate',
   on: ['column1', 'column2'],
   aggregations:  [
      {
          newcolumn: 'sum_value1',
          aggfunction: 'sum',
          column: 'value1'
      }
    // ...
  ]
}
```

### `argmax` step

Get row(s) matching the maximum value in a given `column`, by group if `groups`
is specified.

```javascript
{
    name: 'argmax',
    column: 'value', // column in which to search for max value
    groups: ['group1', 'group2']
}
```

#### Example 1: without `groups`

**Input dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 1 | Group 1 | 13    |
| Label 2 | Group 1 | 7     |
| Label 3 | Group 1 | 20    |
| Label 4 | Group 2 | 1     |
| Label 5 | Group 2 | 10    |
| Label 6 | Group 2 | 5     |

**Step configuration:**

```javascript
{
  {
    name: 'argmax',
    column: 'Value'
  }
}
```

**Output dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 3 | Group 1 | 20    |

#### Example 2: with `groups`

**Input dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 1 | Group 1 | 13    |
| Label 2 | Group 1 | 7     |
| Label 3 | Group 1 | 20    |
| Label 4 | Group 2 | 1     |
| Label 5 | Group 2 | 10    |
| Label 6 | Group 2 | 5     |

**Step configuration:**

```javascript
{
  {
    name: 'argmax',
    column: 'Value',
    groups: ['Group']
  }
}
```

**Output dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 3 | Group 1 | 20    |
| Label 5 | Group 2 | 10    |

### `argmin` step

Get row(s) matching the minimum value in a given `column`, by group if `groups`
is specified.

```javascript
{
  name: 'argmin',
  column: 'value', // column in which to search for max value
  groups: ['group1', 'group2'] // optional
}
```

#### Example 1: without `groups`

**Input dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 1 | Group 1 | 13    |
| Label 2 | Group 1 | 7     |
| Label 3 | Group 1 | 20    |
| Label 4 | Group 2 | 1     |
| Label 5 | Group 2 | 10    |
| Label 6 | Group 2 | 5     |

**Step configuration:**

```javascript
{
  {
    name: 'argmin',
    column: 'Value'
  }
}
```

**Output dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 2 | Group 1 | 7     |

#### Example 2: with `groups`

**Input dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 1 | Group 1 | 13    |
| Label 2 | Group 1 | 7     |
| Label 3 | Group 1 | 20    |
| Label 4 | Group 2 | 1     |
| Label 5 | Group 2 | 10    |
| Label 6 | Group 2 | 5     |

**Step configuration:**

```javascript
{
  {
    name: 'argmin',
    column: 'Value',
    groups: ['Groups']
  }
}
```

**Output dataset:**

| Label   | Group   | Value |
| ------- | ------- | ----- |
| Label 2 | Group 1 | 7     |
| Label 4 | Group 2 | 1     |

### `custom` step

This step allows to define a custom query that can't be expressed using the
other existing steps.

```javascript
{
    name: 'custom',
    query: '$group: {_id: ...}'
}
```

### `delete` step

Delete a column.

```javascript
{
    name: 'delete',
    columns: ['my-column', 'some-other-column']
}
```

### `domain` step

This step is meant to select a specific domain (using MongoDB terminology).

```javascript
{
    name: 'domain',
    domain: 'my-domain'
}
```

### `fillna` step

Replace null values by a given value in a column.

```javascript
{
    name: 'fillna',
    column: "foo",
    value: "bar"
}
```

### `filter` step

Filter out lines that don't match a filter definition.

```javascript
{
    name: 'filter',
    column: 'my-column',
    value: 42,
    operator: 'ne'
}
```

`operator` is optional, and defaults to `eq`. Allowed operators are `eq`, `ne`,
`gt`, `ge`, `lt`, `le`, `in`, `nin`.

`value` can be an arbitrary value (e.g a list when used with the `in` operator)

### `formula` step

Filter out lines that don't match a filter definition.

```javascript
{
    name: 'filter',
    column: 'my-column',
    value: 42
    operator: 'ne'
}
```

#### Example

**Input dataset:**

| Label   | Value1 | Value2 | Value3 | Value4 |
| ------- | ------ | ------ | ------ | ------ |
| Label 1 | 10     | 2      | 3      | 1      |
| Label 2 | 1      | 13     | 7      | 3      |
| Label 3 | 5      | 20     | 5      | 2      |

**Step configuration:**

```javascript
{
  name: 'formula',
  new_column: 'result',
  formula: '(Value1 + Value2) / Value3 - Value4 * 2'
}
```

**Output dataset:**

| Label   | Value1 | Value2 | Value3 | Value4 | Result |
| ------- | ------ | ------ | ------ | ------ | ------ |
| Label 1 | 10     | 2      | 3      | 1      | 2      |
| Label 2 | 1      | 13     | 7      | 3      | -4     |
| Label 3 | 5      | 20     | 5      | 2      | 1      |

### `percentage` step

Compute the percentage of total, i.e. for every row the value in `column` divided
by the total as the sum of every values in `column`. The computation can be performed
by `group` if specified. The result can be either ouput inplace or in a `new_column` if specified

```javascript
{
name: 'percentage',
new_column: 'new_col', // optional
column: 'bar',
group: ['foo'] // optional
}
```

### `pivot` step

Pivot rows into columns around a given `index` (expressed as a combination of column(s)).
Values to be used as new column names are found in the column `column_to_pivot`.
Values to populate new columns are found in the column `value_column`.
The function used to aggregate data (when several rows are found by index group) must be
among `sum`, `avg`, `count`, `min` or `max`.

```javascript
{
 name: 'pivot',
 index: ['column_1', 'column_2'],
 column_to_pivot: 'column_3',
 value_column: 'column_4',
 agg_function: 'sum',
}
```

#### Example:

**Input dataset:**

| Label   | Country  | Value |
| ------- | -------- | ----- |
| Label 1 | Country1 | 13    |
| Label 2 | Country1 | 7     |
| Label 3 | Country1 | 20    |
| Label 1 | Country2 | 1     |
| Label 2 | Country2 | 10    |
| Label 3 | Country2 | 5     |
| label 3 | Country2 | 1     |

**Step configuration:**

```javascript
{
 name: 'pivot',
 index: ['Label'],
 column_to_pivot: 'Country',
 value_column: 'Value',
 agg_function: 'sum',
}
```

**Output dataset:**

| Label   | Country1 | Country2 |
| ------- | -------- | -------- |
| Label 1 | 13       | 1        |
| Label 2 | 7        | 10       |
| Label 3 | 20       | 6        |

### `rename` step

Rename a column.,

```javascript
{
    name: 'filter',
    oldname: 'old-column-name',
    newname: 'new-column-name'
}
```

### `replace` step

Replace one or several values in a column, and write resulting column inplace or in a new column.

A replace step has the following strucure:

```javascript
{
   name: 'replace',
   search_column: "column_1",
   new_column: "column_1", // if empty, replace values directly in `search_column` by default
   to_replace: [
     ['foo', 'bar'], // The first value is the one to be replace, the second is the new value
     [42, 0]
   ]


}
```

### Example 1: Replace a single value inplace

**Input dataset:**

| COMPANY   | COUNTRY |
| --------- | ------- |
| Company 1 | Fr      |
| Company 2 | USA     |

**Step configuration:**

```javascript
{
   name: 'replace',
   search_column: "COUNTRY",
   to_replace: [
     ['Fr', 'France']
   ]
}
```

**Output dataset:**

| COMPANY   | COUNTRY |
| --------- | ------- |
| Company 1 | France  |
| Company 2 | USA     |

### Example 2: Replace several values at once in a new column

**Input dataset:**

| COMPANY   | COUNTRY |
| --------- | ------- |
| Company 1 | France  |
| Company 2 | USA     |

**Step configuration:**

```javascript
{
   name: 'replace',
   search_column: "COUNTRY",
   new_column: "REGION"
   to_replace: [
     ['France', 'Europe']
     ['USA': 'North America']
   ]
}
```

**Output dataset:**

| COMPANY   | COUNTRY | REGION        |
| --------- | ------- | ------------- |
| Company 1 | France  | Europe        |
| Company 2 | USA     | North America |

### `select` step

Select a column. The default is to keep every columns of the input domain. If
the `select` is used, it will only keep selected columns in the output.

```javascript
{
    name: 'select',
    columns: ['my-column', 'some-other-column']
}
```

### `sort` step

Sort values in one or several columns. Order can be either 'asc' or 'desc'.
When sorting on several columns, order of columns specified in `columns` matters,
and the `order` parameter must be of same length as `columns`. By default, if
`order` is not specified, it is considered as 'asc'.

```javascript
{
    name: 'sort',
    columns: ['foo', 'bar'],
    order: ['asc', 'desc']
}
```

### `top` step

Return top N rows by group if `groups` is specified, else over full dataset.

```javascript
{
  name: 'top',
  groups: ['foo'],
  rank_on: 'bar',
  sort: 'desc', // or 'asc'
  limit: 10
}
```

### `unpivot` step

Unpivot a list of columns to rows.

```javascript
{
  name: 'unpivot',
  keep: ['COMPANY', 'COUNTRY'], // columns to keep fixed around which to unpivot columns
  unpivot: ['NB_CLIENTS', 'REVENUES'], // columns to unpivot
  unpivot_column_name: 'KPI', // name of the new dimension column created after unpivot
  value_column_name: 'VALUE', // name of the new value column created after unpivot
  dropna: true // whether null values have to be kept or the corresponding rows discarded
}
```

#### Example 1: with `dropna`parameter to true

**Input dataset:**

| COMPANY   | COUNTRY | NB_CLIENTS | REVENUES |
| --------- | ------- | ---------- | -------- |
| Company 1 | France  | 7          | 10       |
| Company 2 | France  | 2          |          |
| Company 1 | USA     | 12         | 6        |
| Company 2 | USA     | 1          | 3        |

**Step configuration:**

```javascript
{
  name: 'unpivot',
  keep: ['COMPANY', 'COUNTRY'],
  unpivot: ['NB_CLIENTS', 'REVENUES'],
  unpivot_column_name: 'KPI',
  value_column_name: 'VALUE',
  dropna: true
}
```

**Output dataset:**

| COMPANY   | COUNTRY | KPI        | VALUE |
| --------- | ------- | ---------- | ----- |
| Company 1 | France  | NB_CLIENTS | 7     |
| Company 1 | France  | REVENUES   | 10    |
| Company 2 | France  | NB_CLIENTS | 2     |
| Company 1 | USA     | NB_CLIENTS | 12    |
| Company 1 | USA     | REVENUES   | 6     |
| Company 2 | USA     | NB_CLIENTS | 1     |
| Company 2 | USA     | REVENUES   | 3     |

#### Example 1: with `dropna`parameter to false

**Input dataset:**

| COMPANY   | COUNTRY | NB_CLIENTS | REVENUES |
| --------- | ------- | ---------- | -------- |
| Company 1 | France  | 7          | 10       |
| Company 2 | France  | 2          |          |
| Company 1 | USA     | 12         | 6        |
| Company 2 | USA     | 1          | 3        |

**Step configuration:**

```javascript
{
  name: 'unpivot',
  keep: ['COMPANY', 'COUNTRY'],
  unpivot: ['NB_CLIENTS', 'REVENUES'],
  unpivot_column_name: 'KPI',
  value_column_name: 'VALUE',
  dropna: false
}
```

**Output dataset:**

| COMPANY   | COUNTRY | KPI        | VALUE |
| --------- | ------- | ---------- | ----- |
| Company 1 | France  | NB_CLIENTS | 7     |
| Company 1 | France  | REVENUES   | 10    |
| Company 2 | France  | NB_CLIENTS | 2     |
| Company 2 | France  | REVENUES   |       |
| Company 1 | USA     | NB_CLIENTS | 12    |
| Company 1 | USA     | REVENUES   | 6     |
| Company 2 | USA     | NB_CLIENTS | 1     |
| Company 2 | USA     | REVENUES   | 3     |
